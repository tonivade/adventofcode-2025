; https://adventofcode.com/2025/day/2

(import java.lang.String lines)
(import java.lang.String split 1)
(import java.lang.String length)
(import java.lang.String trim)
(import java.lang.String charAt 1)
(import java.lang.String substring 2)
(import java.lang.Long parseLong 1)
(import java.lang.Long toString 1)

(load-file "mal/aoc.mal")

(def! split-pair 
    (fn* [s] 
        (map parseLong (split (trim s) "-"))
    )
)

(def! parse 
    (fn* [file]
        (let* (input (slurp file)) 
            (map split-pair (split input ","))
        )
    )
)

(def! is-repeated? 
    (fn* [s]
        (let* (i (/ (length s) 2)) 
            (= (substring s 0 i) (substring s i (length s)))
        )
    )
)

(def! is-invalid? 
    (fn* [number]
        (let* (s (toString number)) 
            (and (= (% (length s) 2) 0) (is-repeated? s))
        )
    )
)

(def! all-the-same? 
    (fn* [xs]
        (if (empty? xs)
            true
            (let* (frst (first xs)) 
                (for-all? (fn* [item] (= item frst)) xs)
            )
        )
    )
)

(def! expand 
    (fn* [input start]
        (let* (end (/ (count input) 2))
            (if (= start end)
                (list (peek (map join (chunks input start))))
                (cons (peek (map join (chunks input start))) (expand input (incr start)))
            )
        )
    )
)

(def! is-repeated2?
    (fn* [input]
        (not 
            (empty?
                (filter all-the-same? (expand (seq input) 2))
            )
        )
    )
)

(def! is-invalid2? 
    (fn* [number]
        (let* (s (toString number)) 
            (or (all-the-same? (seq s)) (and (= (% (length s) 2) 0) (is-repeated2? s)))
        )
    )
)

(def! unfold 
    (fn* [range]
        (if (= (first range) (second range))
            (if (is-invalid? (first range))
                (list (first range))
                (list)
            )
            (if (is-invalid? (first range))
                (cons (first range) (unfold (list (incr (first range)) (second range))))
                (unfold (list (incr (first range)) (second range)))
            )
        )
    )
)

(def! unfold2 
    (fn* [range]
        (if (= (first range) (second range))
            (if (is-invalid2? (first range))
                (list (first range))
                (list)
            )
            (if (is-invalid2? (first range))
                (cons (first range) (unfold2 (list (incr (first range)) (second range))))
                (unfold2 (list (incr (first range)) (second range)))
            )
        )
    )
)

;(def! input "input/day2.txt")
(def! input "input/day2-test.txt")

; part1
(println
    (reduce 0 +
        (flatten 
            (map unfold (parse input))
        )
    )
)

; part2
(println
    (reduce 0 +
        (flatten 
            (map unfold2 (parse input))
        )
    )
)